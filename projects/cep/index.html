<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questão 01 - CEP com Geolocalização</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            padding: 20px;
            text-align: center;
        }

        .card {
            background: white;
            max-width: 500px;
            margin: 0 auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        /* Inputs e Botões */
        input {
            padding: 12px;
            width: 60%;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
            outline: none;
        }

        input:focus {
            border-color: #007bff;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: 0.3s;
        }

        #btn-consultar {
            background: #007bff;
            color: white;
            margin-left: 10px;
        }

        #btn-consultar:hover {
            background: #0056b3;
        }

        #btn-consultar:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #btn-mapa {
            background: #28a745;
            color: white;
            margin-top: 20px;
            display: none;
            /* Escondido inicialmente [cite: 25] */
            width: 100%;
        }

        #btn-mapa:hover {
            background: #218838;
        }

        /* Área de Resultados */
        .resultado {
            text-align: left;
            margin-top: 20px;
            line-height: 1.8;
            color: #555;
            display: none;
        }

        .resultado strong {
            color: #333;
        }

        /* Iframe do Mapa */
        iframe {
            width: 100%;
            height: 300px;
            border: none;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            /* Escondido inicialmente [cite: 25] */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Mensagem de Erro */
        .erro {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }

        /* Classe utilitária para travar a tela durante carregamento */
        .loading-cursor {
            cursor: wait !important;
        }

        /*  */
        .loading-cursor * {
            cursor: wait !important;
        }
    </style>
</head>

<body>

    <div class="card">
        <h1>Consultar Endereço</h1>

        <div>
            <input type="text" id="input-cep" placeholder="Digite o CEP (apenas números)" maxlength="8">
            <button id="btn-consultar">Consultar</button>
        </div>

        <div id="msg-erro" class="erro"></div>

        <div id="dados-cep" class="resultado">
            <p><strong>Logradouro:</strong> <span id="res-logradouro"></span></p>
            <p><strong>Bairro:</strong> <span id="res-bairro"></span></p>
            <p><strong>Cidade:</strong> <span id="res-cidade"></span></p>
            <p><strong>Estado:</strong> <span id="res-estado"></span></p>
            <p><strong>Latitude:</strong> <span id="res-lat"></span></p>
            <p><strong>Longitude:</strong> <span id="res-lon"></span></p>
        </div>

        <button id="btn-mapa"> Exibir Mapa</button>

        <iframe id="iframe-mapa"></iframe>
    </div>

    <script>
        const inputCep = document.getElementById('input-cep');
        const btnConsultar = document.getElementById('btn-consultar');
        const btnMapa = document.getElementById('btn-mapa');
        const divDados = document.getElementById('dados-cep');
        const divErro = document.getElementById('msg-erro');
        const iframe = document.getElementById('iframe-mapa');

        // Variáveis globais para guardar as coordenadas
        let latitudeAtual = null;
        let longitudeAtual = null;

        // --- FUNÇÃO PRINCIPAL (AGORA 100% ASYNC) ---
        btnConsultar.addEventListener('click', async () => {
            const cep = inputCep.value.replace(/\D/g, '');

            if (cep.length !== 8) {
                mostrarErro("CEP inválido! Digite 8 números.");
                return;
            }

            // 1. Prepara a tela (Loading)
            document.body.classList.add('loading-cursor');
            btnConsultar.disabled = true;
            btnConsultar.innerText = "Pesquisando...";
            limparTela();

            try {
                // 2. Busca na BrasilAPI
                const resp = await fetch(`https://brasilapi.com.br/api/cep/v2/${cep}`);
                if (!resp.ok) throw new Error("CEP não encontrado");

                const dados = await resp.json();

                // 3. Preenche os dados de texto na tela
                const rua = dados.street || "";
                const bairro = dados.neighborhood || "";
                const cidade = dados.city;
                const estado = dados.state;

                document.getElementById('res-logradouro').innerText = rua || "Rua não informada";
                document.getElementById('res-bairro').innerText = bairro || "Bairro não informado";
                document.getElementById('res-cidade').innerText = cidade;
                document.getElementById('res-estado').innerText = estado;

                divDados.style.display = 'block';

                // TENTATIVA 1: O CEP já veio com coordenadas?
                if (dados.location && dados.location.coordinates && dados.location.coordinates.latitude) {
                    console.log("Sucesso: Coordenadas vieram pelo CEP!");
                    latitudeAtual = dados.location.coordinates.latitude;
                    longitudeAtual = dados.location.coordinates.longitude;
                }
                // TENTATIVA 2: Não veio? Vamos buscar o endereço no Nominatim
                else {
                    console.warn("Sem coordenadas no CEP. Buscando Rua + Cidade no Nominatim...");

                    // Tenta achar a RUA exata
                    let achou = await buscarNoNominatim(`${rua}, ${cidade}, ${estado}, Brazil`);

                    // TENTATIVA 3: Não achou a rua? Busca só a CIDADE (melhor que nada)
                    if (!achou) {
                        console.warn("Rua não mapeada. Buscando centro da cidade...");
                        achou = await buscarNoNominatim(`${cidade}, ${estado}, Brazil`);
                    }
                }

                // Se depois de tudo isso tivermos coordenadas, atualiza a tela
                if (latitudeAtual && longitudeAtual) {
                    document.getElementById('res-lat').innerText = latitudeAtual;
                    document.getElementById('res-lon').innerText = longitudeAtual;
                    btnMapa.style.display = 'inline-block';
                } else {
                    document.getElementById('res-lat').innerText = "Indisponível";
                    document.getElementById('res-lon').innerText = "Indisponível";
                    mostrarErro("Endereço encontrado, mas o mapa não pôde ser gerado.");
                }

            } catch (erro) {
                mostrarErro("CEP não encontrado ou erro de conexão.");
                console.error(erro);
            } finally {
                // Destrava a tela
                document.body.classList.remove('loading-cursor');
                btnConsultar.disabled = false;
                btnConsultar.innerText = "Consultar";
            }
        });

        // --- FUNÇÃO AUXILIAR PARA BUSCAR NO NOMINATIM ---
        async function buscarNoNominatim(query) {
            try {
                // EncodeURIComponent é vital para lidar com acentos (Sobral, Ceará)
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`;

                const resp = await fetch(url, { headers: { 'User-Agent': 'AppConsultaCEP/1.0' } });
                const dadosGeo = await resp.json();

                if (dadosGeo && dadosGeo.length > 0) {
                    latitudeAtual = dadosGeo[0].lat;
                    longitudeAtual = dadosGeo[0].lon;
                    return true; // Achou!
                }
                return false; // Não achou
            } catch (e) {
                console.error("Erro no Nominatim:", e);
                return false;
            }
        }

        // --- BOTÃO DO MAPA ---
        btnMapa.addEventListener('click', () => {
            if (!latitudeAtual || !longitudeAtual) return;

            // URL PADRÃO E SEGURA DO GOOGLE MAPS EMBED
            // O formato antigo 'googleusercontent' costuma dar erro. Esse aqui é o oficial.
            const urlMapa = `https://maps.google.com/maps?q=${latitudeAtual},${longitudeAtual}&hl=pt&z=15&output=embed`;

            iframe.src = urlMapa;
            iframe.style.display = 'block';
        });

        // --- UTILITÁRIOS ---
        function mostrarErro(msg) {
            divErro.innerText = msg;
            divErro.style.display = 'block';
        }

        function limparTela() {
            divErro.style.display = 'none';
            divDados.style.display = 'none';
            btnMapa.style.display = 'none';
            iframe.style.display = 'none';
            iframe.src = '';
            latitudeAtual = null;
            longitudeAtual = null;
        }
    </script>
</body>

</html>